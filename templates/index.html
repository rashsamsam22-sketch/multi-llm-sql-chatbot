<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>SQL Query Chatbot - Multi-LLM</title>
    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message {
            animation: fadeIn 0.3s ease-in;
        }

        .sql-query {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .copy-btn:hover {
            background: #5568d3;
        }

        .file-upload-area {
            border: 2px dashed #cbd5e0;
            transition: all 0.3s;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background-color: #f7fafc;
        }

        .file-upload-area.dragging {
            border-color: #667eea;
            background-color: #ebf4ff;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <div class="flex items-center justify-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 bg-clip-text text-transparent">
                ü§ñ SQL Query Chatbot
            </h1>
        </div>

        <!-- Main Container -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Sidebar -->
            <div class="lg:col-span-1 space-y-6">
                <!-- File Upload Card -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        Upload Files
                    </h3>
                    
                    <div class="file-upload-area rounded-xl p-6 text-center cursor-pointer" id="uploadArea">
                        <input type="file" id="fileInput" multiple accept=".csv,.xlsx,.xls" class="hidden">
                        <svg class="w-12 h-12 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p class="text-sm text-gray-600 font-semibold">Click to upload or drag & drop</p>
                        <p class="text-xs text-gray-500 mt-1">CSV, Excel files</p>
                    </div>

                    <!-- Uploaded Files List -->
                    <div id="filesList" class="mt-4 space-y-2 max-h-48 overflow-y-auto"></div>
                </div>

                <!-- Model Selection Card -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                        </svg>
                        Select LLM Model
                    </h3>
                    <select id="model-selector" class="w-full bg-gray-50 border-2 border-gray-300 rounded-xl px-4 py-3 text-gray-800 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all">
                        <option value="llama3.1-8b">Llama 3.1 8B</option>
                        <option value="llama-4-scout">Llama 4 Scout</option>
                        <option value="gpt-oss-120b">GPT-OSS 120B</option>
                        <option value="qwen-3-32b">Qwen 3 32B</option>
                    </select>
                </div>

                <!-- Database Schema Card -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                        </svg>
                        Database Schema
                    </h3>
                    <div id="schema-content" class="bg-gray-50 border-2 border-gray-200 rounded-xl p-4 max-h-64 overflow-y-auto text-xs font-mono text-gray-700 whitespace-pre-wrap">
                        No files uploaded yet. Please upload CSV or Excel files to get started.
                    </div>
                </div>

                <!-- Example Queries Card -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                        </svg>
                        Example Queries
                    </h3>
                    <div class="space-y-2">
                        <div class="example-query bg-gray-50 border-2 border-gray-200 rounded-lg px-4 py-2.5 text-sm text-gray-700 cursor-pointer hover:bg-blue-50 hover:border-blue-500 hover:text-blue-700 transition-all duration-300" onclick="useExample(this)">
                            Show all data from the first table
                        </div>
                        <div class="example-query bg-gray-50 border-2 border-gray-200 rounded-lg px-4 py-2.5 text-sm text-gray-700 cursor-pointer hover:bg-blue-50 hover:border-blue-500 hover:text-blue-700 transition-all duration-300" onclick="useExample(this)">
                            Count total rows in each table
                        </div>
                        <div class="example-query bg-gray-50 border-2 border-gray-200 rounded-lg px-4 py-2.5 text-sm text-gray-700 cursor-pointer hover:bg-blue-50 hover:border-blue-500 hover:text-blue-700 transition-all duration-300" onclick="useExample(this)">
                            Show column names and types
                        </div>
                        <div class="example-query bg-gray-50 border-2 border-gray-200 rounded-lg px-4 py-2.5 text-sm text-gray-700 cursor-pointer hover:bg-blue-50 hover:border-blue-500 hover:text-blue-700 transition-all duration-300" onclick="useExample(this)">
                            Get first 10 rows
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">
                    <!-- Chat Header -->
                    <div class="bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 px-6 py-4">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                            Conversation
                        </h2>
                    </div>

                    <!-- Chat Messages -->
                    <div id="messages" class="h-96 overflow-y-auto p-6 space-y-4 bg-gray-50">
                        <!-- Empty State -->
                        <div id="empty-state" class="flex flex-col items-center justify-center h-full text-center space-y-4">
                            <svg class="w-16 h-16 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <div>
                                <p class="text-gray-400 font-semibold text-lg">Upload files to get started</p>
                                <p class="text-gray-400 text-sm mt-1">Upload CSV or Excel files and start asking questions</p>
                            </div>
                        </div>
                    </div>

                    <!-- Input Form -->
                    <div class="bg-white border-t-2 border-gray-200 p-4">
                        <form id="chatForm" class="flex gap-3">
                            <input
                                class="flex-1 bg-gray-50 border-2 border-gray-300 rounded-xl px-4 py-3 text-gray-800 placeholder-gray-400 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                                placeholder="Ask a question about your data..."
                                type="text"
                                id="user-input"
                                autocomplete="off"
                                required>
                            <button
                                class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-8 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl hover:from-blue-600 hover:to-indigo-700 transition-all duration-300 flex items-center gap-2"
                                type="submit"
                                id="send-btn">
                                <span id="btnText">Send</span>
                                <svg id="sendIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                </svg>
                                <svg id="loadingIcon" class="w-5 h-5 animate-spin hidden" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Help Text -->
                <div class="mt-4 text-center">
                    <p class="text-sm text-gray-500">
                        üí° Tip: Upload your CSV/Excel files first, then ask questions about your data
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadSchema();
            loadTables();
            setupFileUpload();
            document.getElementById('user-input').focus();
        });

        // File Upload Setup
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragging');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragging');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragging');
                const files = e.dataTransfer.files;
                handleFileUpload(files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFileUpload(e.target.files);
            });
        }

        async function handleFileUpload(files) {
            if (files.length === 0) return;

            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }

            try {
                // Show loading
                showNotification('Uploading files...', 'info');

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Files uploaded successfully!', 'success');
                    loadTables();
                    loadSchema();
                    
                    // Clear file input
                    document.getElementById('fileInput').value = '';
                } else {
                    showNotification('Error uploading files', 'error');
                }
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        async function loadTables() {
            try {
                const response = await fetch('/api/tables');
                const data = await response.json();

                const filesList = document.getElementById('filesList');
                filesList.innerHTML = '';

                if (data.tables && data.tables.length > 0) {
                    data.tables.forEach(table => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg px-3 py-2';
                        fileItem.innerHTML = `
                            <div class="flex items-center gap-2 flex-1 min-w-0">
                                <svg class="w-4 h-4 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <span class="text-sm text-gray-700 truncate" title="${table.original_name}">${table.original_name}</span>
                            </div>
                            <button onclick="deleteTable('${table.table_name}')" class="text-red-500 hover:text-red-700 flex-shrink-0 ml-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        `;
                        filesList.appendChild(fileItem);
                    });
                }
            } catch (error) {
                console.error('Error loading tables:', error);
            }
        }

        async function deleteTable(tableName) {
            if (!confirm('Are you sure you want to delete this table?')) return;

            try {
                const response = await fetch(`/api/tables/${tableName}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Table deleted successfully', 'success');
                    loadTables();
                    loadSchema();
                } else {
                    showNotification('Error deleting table', 'error');
                }
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        async function loadSchema() {
            try {
                const response = await fetch('/api/schema');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('schema-content').textContent = data.schema;
                } else {
                    document.getElementById('schema-content').textContent = 'Error loading schema';
                }
            } catch (error) {
                document.getElementById('schema-content').textContent = 'Error loading schema';
                console.error('Error:', error);
            }
        }

        function useExample(element) {
            document.getElementById('user-input').value = element.textContent.trim();
            document.getElementById('user-input').focus();
        }

        function scrollToBottom() {
            const chatContainer = document.getElementById('messages');
            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // Handle form submission
        const form = document.getElementById('chatForm');
        const sendBtn = document.getElementById('send-btn');
        const btnText = document.getElementById('btnText');
        const sendIcon = document.getElementById('sendIcon');
        const loadingIcon = document.getElementById('loadingIcon');
        
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const input = document.getElementById('user-input');
            const question = input.value.trim();
            
            if (!question) return;

            const model = document.getElementById('model-selector').value;
            
            // Clear input and show loading state
            input.value = '';
            btnText.textContent = 'Sending...';
            sendIcon.classList.add('hidden');
            loadingIcon.classList.remove('hidden');
            sendBtn.disabled = true;
            sendBtn.classList.add('opacity-75', 'cursor-not-allowed');

            // Remove empty state if exists
            const emptyState = document.getElementById('empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            // Add user message
            addUserMessage(question);

            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question, model })
                });

                const data = await response.json();

                if (data.success) {
                    addBotResponse(data);
                } else {
                    addErrorMessage(data.error);
                }
            } catch (error) {
                addErrorMessage(error.message);
            } finally {
                // Reset button state
                btnText.textContent = 'Send';
                sendIcon.classList.remove('hidden');
                loadingIcon.classList.add('hidden');
                sendBtn.disabled = false;
                sendBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                input.focus();
            }
        });

        function addUserMessage(content) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message flex justify-end';
            
            messageDiv.innerHTML = `
                <div class="max-w-xl">
                    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-5 py-3 rounded-2xl rounded-tr-sm shadow-md">
                        <p class="text-sm leading-relaxed break-words">${escapeHtml(content)}</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 mr-2 text-right">You</p>
                </div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        function addBotResponse(data) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message flex justify-start';
            
            let resultHtml = '';
            if (data.execution.success) {
                resultHtml = `
                    <div class="mt-3 p-4 bg-green-50 border-l-4 border-green-500 rounded-lg">
                        <p class="text-sm font-semibold text-green-800 mb-2">‚úì Query Executed Successfully</p>
                        <pre class="text-xs text-gray-700 whitespace-pre-wrap font-mono max-h-48 overflow-y-auto">${escapeHtml(data.execution.data)}</pre>
                    </div>
                `;
            } else {
                resultHtml = `
                    <div class="mt-3 p-4 bg-red-50 border-l-4 border-red-500 rounded-lg">
                        <p class="text-sm font-semibold text-red-800 mb-2">‚úó Execution Error</p>
                        <p class="text-xs text-red-700">${escapeHtml(data.execution.error)}</p>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="max-w-2xl">
                    <div class="bg-white border-2 border-gray-200 text-gray-800 px-5 py-3 rounded-2xl rounded-tl-sm shadow-md">
                        <p class="text-sm font-semibold text-blue-600 mb-2">${data.model}</p>
                        <p class="text-sm mb-2">Generated SQL Query:</p>
                        <div class="sql-query">
                            <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
                            <code class="text-xs">${escapeHtml(data.sql_query)}</code>
                        </div>
                        ${resultHtml}
                    </div>
                    <p class="text-xs text-gray-500 mt-1 ml-2">AI Assistant</p>
                </div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        function addErrorMessage(error) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message flex justify-start';
            
            messageDiv.innerHTML = `
                <div class="max-w-xl">
                    <div class="bg-red-50 border-2 border-red-200 text-red-800 px-5 py-3 rounded-2xl rounded-tl-sm shadow-md">
                        <p class="text-sm leading-relaxed break-words">‚ùå Error: ${escapeHtml(error)}</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 ml-2">AI Assistant</p>
                </div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        function copyToClipboard(button) {
            const sqlQuery = button.nextElementSibling.textContent;
            navigator.clipboard.writeText(sqlQuery).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            });
        }

        function showNotification(message, type) {
            // Simple notification - you can enhance this
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>